"use strict";!function(){function e(e){return e>>4}function r(e){return 15&e}function t(t){var o=r(t),n=e(t);return"abcdefgh".substring(o,o+1)+"87654321".substring(n,n+1)}function o(e){return e===p?u:p}function n(e){return-1!=="0123456789".indexOf(e)}function i(e){var r=e instanceof Array?[]:{};for(var t in e)r[t]="object"==typeof t?i(e[t]):e[t];return r}function a(e){return e.replace(/^\s+|\s+$/g,"")}var s,f,u="b",p="w",l=-1,_="p",h="n",d="b",c="r",v="q",g="k",m="pnbrqkPNBRQK",b="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",y=["1-0","0-1","1/2-1/2","*"],E={b:[16,32,17,15],w:[-16,-32,-17,-15]},k={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]};!function(){s=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],f=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17]}();var A,S={p:0,n:1,b:2,r:3,q:4,k:5},C={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},T={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},I=7,P=6,L=1,R=0;!function(){A={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119}}();var O={w:[{square:A.a1,flag:T.QSIDE_CASTLE},{square:A.h1,flag:T.KSIDE_CASTLE}],b:[{square:A.a8,flag:T.QSIDE_CASTLE},{square:A.h8,flag:T.KSIDE_CASTLE}]},w=function(e){var r={board:new Array(128),kings:{w:l,b:l},turn:p,castling:{w:0,b:0},ep_square:l,half_moves:0,move_number:1,history:[],header:{}};this._pos=function(){return r},"undefined"==typeof e?this.load(b):this.load(e)};w.WHITE=p,w.BLACK=u,w.PAWN=_,w.KNIGHT=h,w.BISHOP=d,w.ROOK=c,w.QUEEN=v,w.KING=g,w.SQUARES=function(){for(var e=[],r=A.a8;r<=A.h1;r++)136&r?r+=7:e.push(t(r));return e}(),w.FLAGS=C,w.prototype.load=function(e){var r=this._pos(),o=e.split(/\s+/),i=o[0],a=0;if(!this.validate_fen(e).valid)return!1;this.clear();for(var s=0;s<i.length;s++){var f=i.charAt(s);if("/"===f)a+=8;else if(n(f))a+=parseInt(f,10);else{var _="a">f?p:u;this.put({type:f.toLowerCase(),color:_},t(a)),a++}}return r.turn=o[1],o[2].indexOf("K")>-1&&(r.castling.w|=T.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(r.castling.w|=T.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(r.castling.b|=T.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(r.castling.b|=T.QSIDE_CASTLE),r.ep_square="-"===o[3]?l:A[o[3]],r.half_moves=parseInt(o[4],10),r.move_number=parseInt(o[5],10),this._update_setup(this._generate_fen()),!0},w.prototype.reset=function(){this.load(b)},w.prototype.moves=function(e){for(var r=this._generate_moves(e),t=[],o=0,n=r.length;n>o;o++)"undefined"!=typeof e&&"verbose"in e&&e.verbose?t.push(this._make_pretty(r[o])):t.push(this._move_to_san(r[o]));return t},w.prototype.in_check=function(){return this._king_attacked(this._pos().turn)},w.prototype.in_checkmate=function(){return this.in_check()&&0===this._generate_moves().length},w.prototype.in_stalemate=function(){return!this.in_check()&&0===this._generate_moves().length},w.prototype.in_draw=function(){return this._pos().half_moves>=100||this.in_stalemate()||this.insufficient_material()||this.in_threefold_repetition()},w.prototype.insufficient_material=function(){for(var e={},r=[],t=0,o=0,n=this._pos(),i=A.a8;i<=A.h1;i++)if(o=(o+1)%2,136&i)i+=7;else{var a=n.board[i];a&&(e[a.type]=a.type in e?e[a.type]+1:1,a.type===d&&r.push(o),t++)}if(2===t)return!0;if(3===t&&(1===e[d]||1===e[h]))return!0;if(t===e[d]+2){for(var s=0,f=r.length,i=0;f>i;i++)s+=r[i];if(0===s||s===f)return!0}return!1},w.prototype.in_threefold_repetition=function(){for(var e=[],r={},t=!1;;){var o=this._undo_move();if(!o)break;e.push(o)}for(;;){var n=this._generate_fen().split(" ").slice(0,4).join(" ");if(r[n]=n in r?r[n]+1:1,r[n]>=3&&(t=!0),!e.length)break;this._make_move(e.pop())}return t},w.prototype.game_over=function(){return this._pos().half_moves>=100||this.in_checkmate()||this.in_stalemate()||this.insufficient_material()||this.in_threefold_repetition()},w.prototype.validate_fen=function(e){var r={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large]."},t=e.split(/\s+/);if(6!==t.length)return{valid:!1,error_number:1,error:r[1]};if(isNaN(t[5])||parseInt(t[5],10)<=0)return{valid:!1,error_number:2,error:r[2]};if(isNaN(t[4])||parseInt(t[4],10)<0)return{valid:!1,error_number:3,error:r[3]};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{valid:!1,error_number:4,error:r[4]};if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(t[2]))return{valid:!1,error_number:5,error:r[5]};if(!/^(w|b)$/.test(t[1]))return{valid:!1,error_number:6,error:r[6]};var o=t[0].split("/");if(8!==o.length)return{valid:!1,error_number:7,error:r[7]};for(var n=0;n<o.length;n++){for(var i=0,a=!1,s=0;s<o[n].length;s++)if(isNaN(o[n][s])){if(!/^[prnbqkPRNBQK]$/.test(o[n][s]))return{valid:!1,error_number:9,error:r[9]};i+=1,a=!1}else{if(a)return{valid:!1,error_number:8,error:r[8]};i+=parseInt(o[n][s],10),a=!0}if(8!==i)return{valid:!1,error_number:10,error:r[10]}}return{valid:!0,error_number:0,error:r[0]}},w.prototype.fen=function(){return this._generate_fen(arguments)},w.prototype.pgn=function(e){var r="object"==typeof e&&"string"==typeof e.newline_char?e.newline_char:"\n",t="object"==typeof e&&"number"==typeof e.max_width?e.max_width:0,o=[],n=!1,i=this._pos();for(var a in i.header)o.push("["+a+' "'+i.header[a]+'"]'+r),n=!0;n&&i.history.length&&o.push(r);for(var s=[];i.history.length>0;)s.push(this._undo_move());for(var f=[],u="",p=1;s.length>0;){var l=s.pop();1===p&&"b"===l.color?(u="1. ...",p++):"w"===l.color&&(u.length&&f.push(u),u=p+".",p++),u=u+" "+this._move_to_san(l),this._make_move(l)}if(u.length&&f.push(u),"undefined"!=typeof i.header.Result&&f.push(i.header.Result),0===t)return o.join("")+f.join(" ");for(var _=0,a=0;a<f.length;a++)_+f[a].length>t&&0!==a?(" "===o[o.length-1]&&o.pop(),o.push(r),_=0):0!==a&&(o.push(" "),_++),o.push(f[a]),_+=f[a].length;return o.join("")},w.prototype.load_pgn=function(e,r){function t(e){return e.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function o(e){var r=!1;for(var t in e)r=!0;return r}function n(e,r){for(var t="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",o={},n=e.split(t),i="",s="",f=0;f<n.length;f++)i=n[f].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1"),s=n[f].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1"),a(i).length>0&&(o[i]=s);return o}var i=this._pos(),s="object"==typeof r&&"string"==typeof r.newline_char?r.newline_char:"\r?\n",f=new RegExp("^(\\[(.|"+t(s)+")*\\])"+"("+t(s)+")*"+"1.("+t(s)+"|.)*$","g"),u=e.replace(f,"$1");"["!==u[0]&&(u=""),this.reset();var p=n(u,r);for(var l in p)this._set_header([l,p[l]]);var _=e.replace(u,"").replace(new RegExp(t(s),"g")," ");_=_.replace(/(\{[^}]+\})+?/g,""),_=_.replace(/\d+\./g,"");var h=a(_).split(new RegExp(/\s+/));h=h.join(",").replace(/,,+/g,",").split(",");for(var d="",c=0;c<h.length-1;c++){if(d=this._move_from_san(a(h[c])),null==d)return!1;this._make_move(d)}if(d=h[h.length-1],y.indexOf(d)>-1)o(i.header)&&"undefined"==typeof i.header.Result&&this._set_header(["Result",d]);else{if(d=this._move_from_san(a(d)),null==d)return!1;this._make_move(d)}return!0},w.prototype.header=function(e){this._set_header(e)},w.prototype.ascii=function(){for(var t="   +------------------------+\n",o=this.getBoard(),n=A.a8;n<=A.h1;n++){if(0===r(n)&&(t+=" "+"87654321"[e(n)]+" |"),null==o[n])t+=" . ";else{var i=o[n].type,a=o[n].color,s=a===p?i.toUpperCase():i.toLowerCase();t+=" "+s+" "}136&n+1&&(t+="|\n",n+=8)}return t+="   +------------------------+\n",t+="     a  b  c  d  e  f  g  h\n"},w.prototype.turn=function(){return this._pos().turn},w.prototype.move=function(e){var r=null,o=this._generate_moves();if("string"==typeof e){for(var n=0,i=o.length;i>n;n++)if(e===this._move_to_san(o[n])){r=o[n];break}}else if("object"==typeof e)for(var n=0,i=o.length;i>n;n++)if(!(e.from!==t(o[n].from)||e.to!==t(o[n].to)||"promotion"in o[n]&&e.promotion!==o[n].promotion)){r=o[n];break}if(!r)return null;var a=this._make_pretty(r);return this._make_move(r),a},w.prototype.undo=function(){var e=this._undo_move();return e?this._make_pretty(e):null},w.prototype.clear=function(){var e=this._pos();e.board=new Array(128),e.kings={w:l,b:l},e.turn=p,e.castling={w:0,b:0},e.ep_square=l,e.half_moves=0,e.move_number=1,e.history=[],e.header={},this._update_setup(this._generate_fen())},w.prototype.put=function(e,r){if(!("type"in e&&"color"in e))return!1;if(!e.type||-1===m.indexOf(e.type.toLowerCase()))return!1;if(!(r in A))return!1;var t=A[r];return this._pos().board[t]={type:e.type,color:e.color},e.type===g&&(this._pos().kings[e.color]=t),this._update_setup(this._generate_fen()),!0},w.prototype.get=function(e){var r=this._pos().board[A[e]];return r?{type:r.type,color:r.color}:null},w.prototype.remove=function(e){var r=this.get(e);return this._pos().board[A[e]]=null,r&&r.type===g&&(this._pos().kings[r.color]=l),this._update_setup(this._generate_fen()),r},w.prototype.square_color=function(t){if(t in A){var o=A[t];return 0===(e(o)+r(o))%2?"light":"dark"}return null},w.prototype.history=function(e){for(var r=this._pos(),t=[],o=[],n=("undefined"!=typeof e&&"verbose"in e&&e.verbose);r.history.length>0;)t.push(this._undo_move());for(;t.length>0;){var i=t.pop();n?o.push(this._make_pretty(i)):o.push(this._move_to_san(i)),this._make_move(i)}return o},w.prototype._generate_fen=function(){for(var e=0,r="",o=this._pos(),n=A.a8;n<=A.h1;n++){if(null==o.board[n])e++;else{e>0&&(r+=e,e=0);var i=o.board[n].color,a=o.board[n].type;r+=i===p?a.toUpperCase():a.toLowerCase()}136&n+1&&(e>0&&(r+=e),n!==A.h1&&(r+="/"),e=0,n+=8)}var s="";o.castling[p]&T.KSIDE_CASTLE&&(s+="K"),o.castling[p]&T.QSIDE_CASTLE&&(s+="Q"),o.castling[u]&T.KSIDE_CASTLE&&(s+="k"),o.castling[u]&T.QSIDE_CASTLE&&(s+="q"),s=s||"-";var f=o.ep_square===l?"-":t(o.ep_square);return[r,o.turn,s,f,o.half_moves,o.move_number].join(" ")},w.prototype._set_header=function(e){for(var r=0;r<e.length;r+=2)"string"==typeof e[r]&&"string"==typeof e[r+1]&&(this._pos().header[e[r]]=e[r+1]);return this._pos().header},w.prototype._update_setup=function(e){var r=this._pos();r.history.length>0||(e!==b?(r.header.SetUp=e,r.header.FEN="1"):(delete r.header.SetUp,delete r.header.FEN))},w.prototype._build_move=function(e,r,t,o,n){var i={color:this._pos().turn,from:r,to:t,flags:o,piece:e[r].type};return n&&(i.flags|=T.PROMOTION,i.promotion=n),e[t]?i.captured=e[t].type:o&T.EP_CAPTURE&&(i.captured=_),i},w.prototype._generate_moves=function(r){this.add_move=function(r,t,o,n,i){if(r[o].type!==_||e(n)!==R&&e(n)!==I)t.push(this._build_move(r,o,n,i));else for(var a=[v,c,d,h],s=0,f=a.length;f>s;s++)t.push(this._build_move(r,o,n,i,a[s]))};var t=this._pos(),n=[],i=t.turn,a=o(i),s={b:L,w:P},f=A.a8,u=A.h1,p=!1,l="undefined"!=typeof r&&"legal"in r?r.legal:!0;if("undefined"!=typeof r&&"square"in r){if(!(r.square in A))return[];f=u=A[r.square],p=!0}for(var g=f;u>=g;g++)if(136&g)g+=7;else{var m=t.board[g];if(null!=m&&m.color===i)if(m.type===_){var b=g+E[i][0];if(null==t.board[b]){this.add_move(t.board,n,g,b,T.NORMAL);var b=g+E[i][1];s[i]===e(g)&&null==t.board[b]&&this.add_move(t.board,n,g,b,T.BIG_PAWN)}for(y=2;4>y;y++){var b=g+E[i][y];136&b||(null!=t.board[b]&&t.board[b].color===a?this.add_move(t.board,n,g,b,T.CAPTURE):b===t.ep_square&&this.add_move(t.board,n,g,t.ep_square,T.EP_CAPTURE))}}else for(var y=0,S=k[m.type].length;S>y;y++)for(var C=k[m.type][y],b=g;;){if(b+=C,136&b)break;if(null!=t.board[b]){if(t.board[b].color===i)break;this.add_move(t.board,n,g,b,T.CAPTURE);break}if(this.add_move(t.board,n,g,b,T.NORMAL),"n"===m.type||"k"===m.type)break}}if(!p||u===t.kings[i]){if(t.castling[i]&T.KSIDE_CASTLE){var O=t.kings[i],w=O+2;null!=t.board[O+1]||null!=t.board[w]||this._attacked(a,t.kings[i])||this._attacked(a,O+1)||this._attacked(a,w)||this.add_move(t.board,n,t.kings[i],w,T.KSIDE_CASTLE)}if(t.castling[i]&T.QSIDE_CASTLE){var O=t.kings[i],w=O-2;null!=t.board[O-1]||null!=t.board[O-2]||null!=t.board[O-3]||this._attacked(a,t.kings[i])||this._attacked(a,O-1)||this._attacked(a,w)||this.add_move(t.board,n,t.kings[i],w,T.QSIDE_CASTLE)}}if(!l)return n;for(var q=[],g=0,S=n.length;S>g;g++)this._make_move(n[g]),this._king_attacked(i)||q.push(n[g]),this._undo_move();return q},w.prototype._move_to_san=function(e){var r="";if(e.flags&T.KSIDE_CASTLE)r="O-O";else if(e.flags&T.QSIDE_CASTLE)r="O-O-O";else{var o=this._get_disambiguator(e);e.piece!==_&&(r+=e.piece.toUpperCase()+o),e.flags&(T.CAPTURE|T.EP_CAPTURE)&&(e.piece===_&&(r+=t(e.from)[0]),r+="x"),r+=t(e.to),e.flags&T.PROMOTION&&(r+="="+e.promotion.toUpperCase())}return this._make_move(e),this.in_check()&&(r+=this.in_checkmate()?"#":"+"),this._undo_move(),r},w.prototype._move_from_san=function(e){var r,o,n,i=T.NORMAL,a=e.match(/^([NBKRQ])?([abcdefgh12345678][12345678]?)?(x)?([abcdefgh][12345678])(=[NBRQ])?/),s=this._pos();if("O-O-O"===e.slice(0,5))o=s.kings[s.turn],r=o-2,i=T.QSIDE_CASTLE;else if("O-O"===e.slice(0,3))o=s.kings[s.turn],r=o+2,i=T.KSIDE_CASTLE;else if(a&&a[1]){var f=a[1].toLowerCase();a[3]&&(i=T.CAPTURE),r=A[a[4]];for(var u=0,p=k[f].length;p>u;u++)for(var l=k[f][u],h=r;;){if(h+=l,136&h)break;var d=s.board[h];if(d){d.color===s.turn&&d.type===f&&(!a[2]||t(h).indexOf(a[2])>=0)&&(o=h);break}if("n"===f||"k"===f)break}}else if(a){if(a[3]){r=A[a[4]];for(var u=2;4>u;u++){var h=r-E[s.turn][u];136&h||null!=s.board[h]&&s.board[h].color===s.turn&&t(h)[0]===a[2]&&(o=h)}i=s.board[r]?T.CAPTURE:T.EP_CAPTURE}else{r=A[e.slice(0,2)];var c=r-E[s.turn][0],d=s.board[c];d&&d.type===_&&d.color===s.turn?o=c:(c=r-E[s.turn][1],d=s.board[c],d&&d.type===_&&d.color===s.turn&&(o=c,i=T.BIG_PAWN))}a[5]&&(n=a[5][1].toLowerCase())}return o>=0&&r>=0&&i?this._build_move(s.board,o,r,i,n):(e.length>0,void 0)},w.prototype._attacked=function(e,r){for(var t=this._pos().board,o=A.a8;o<=A.h1;o++)if(136&o)o+=7;else if(null!=t[o]&&t[o].color===e){var n=t[o],i=o-r,a=i+119;if(s[a]&1<<S[n.type]){if(n.type===_){if(i>0){if(n.color===p)return!0}else if(n.color===u)return!0;continue}if("n"===n.type||"k"===n.type)return!0;for(var l=f[a],h=o+l,d=!1;h!==r;){if(null!=t[h]){d=!0;break}h+=l}if(!d)return!0}}return!1},w.prototype._king_attacked=function(e){return this._attacked(o(e),this._pos().kings[e])},w.prototype._push=function(e){var r=this._pos();r.history.push({move:e,kings:{b:r.kings.b,w:r.kings.w},turn:r.turn,castling:{b:r.castling.b,w:r.castling.w},ep_square:r.ep_square,half_moves:r.half_moves,move_number:r.move_number})},w.prototype._make_move=function(e){var r=this._pos(),t=r.turn,n=o(t);if(this._push(e),r.board[e.to]=r.board[e.from],r.board[e.from]=null,e.flags&T.EP_CAPTURE&&(r.turn===u?r.board[e.to-16]=null:r.board[e.to+16]=null),e.flags&T.PROMOTION&&(r.board[e.to]={type:e.promotion,color:t}),r.board[e.to].type===g){if(r.kings[r.board[e.to].color]=e.to,e.flags&T.KSIDE_CASTLE){var i=e.to-1,a=e.to+1;r.board[i]=r.board[a],r.board[a]=null}else if(e.flags&T.QSIDE_CASTLE){var i=e.to+1,a=e.to-2;r.board[i]=r.board[a],r.board[a]=null}r.castling[t]=""}if(r.castling[t])for(var s=0,f=O[t].length;f>s;s++)if(e.from===O[t][s].square&&r.castling[t]&O[t][s].flag){r.castling[t]^=O[t][s].flag;break}if(r.castling[n])for(var s=0,f=O[n].length;f>s;s++)if(e.to===O[n][s].square&&r.castling[n]&O[n][s].flag){r.castling[n]^=O[n][s].flag;break}r.ep_square=e.flags&T.BIG_PAWN?"b"===r.turn?e.to-16:e.to+16:l,e.piece===_?r.half_moves=0:e.flags&(T.CAPTURE|T.EP_CAPTURE)?r.half_moves=0:r.half_moves++,r.turn===u&&r.move_number++,r.turn=o(r.turn)},w.prototype._undo_move=function(){var e=this._pos(),r=e.history.pop();if(null==r)return null;var t=r.move;e.kings=r.kings,e.turn=r.turn,e.castling=r.castling,e.ep_square=r.ep_square,e.half_moves=r.half_moves,e.move_number=r.move_number;var n=e.turn,i=o(e.turn);if(e.board[t.from]=e.board[t.to],e.board[t.from].type=t.piece,e.board[t.to]=null,t.flags&T.CAPTURE)e.board[t.to]={type:t.captured,color:i};else if(t.flags&T.EP_CAPTURE){var a;a=n===u?t.to-16:t.to+16,e.board[a]={type:_,color:i}}if(t.flags&(T.KSIDE_CASTLE|T.QSIDE_CASTLE)){var s,f;t.flags&T.KSIDE_CASTLE?(s=t.to+1,f=t.to-1):t.flags&T.QSIDE_CASTLE&&(s=t.to-2,f=t.to+1),e.board[s]=e.board[f],e.board[f]=null}return t},w.prototype._get_disambiguator=function(o){for(var n=this._generate_moves(),i=o.from,a=o.to,s=o.piece,f=0,u=0,p=0,l=0,_=n.length;_>l;l++){var h=n[l].from,d=n[l].to,c=n[l].piece;s===c&&i!==h&&a===d&&(f++,e(i)===e(h)&&u++,r(i)===r(h)&&p++)}return f>0?u>0&&p>0?t(i):p>0?t(i).charAt(1):t(i).charAt(0):""},w.prototype._make_pretty=function(e){var r=i(e);r.san=this._move_to_san(r),r.to=t(r.to),r.from=t(r.from);var o="";for(var n in T)T[n]&r.flags&&(o+=C[n]);return r.flags=o,r},w.prototype._perft=function(e){for(var r=this._generate_moves({legal:!1}),t=0,o=this._pos().turn,n=0,i=r.length;i>n;n++){if(this._make_move(r[n]),!this._king_attacked(o))if(e-1>0){var a=this._perft(e-1);t+=a}else t++;this._undo_move()}return t},"undefined"!=typeof exports&&(exports.Chess=w)}();