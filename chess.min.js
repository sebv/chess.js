"use strict";!function(){var e="b";var r="w";var t=-1;var a="p";var i="n";var o="b";var n="r";var s="q";var f="k";var l="pnbrqkPNBRQK";var u="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1";var v=["1-0","0-1","1/2-1/2","*"];var p={b:[16,32,17,15],w:[-16,-32,-17,-15]};var _={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]};var h,d;!function(){h=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20];d=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17]}();var c={p:0,n:1,b:2,r:3,q:4,k:5};var g={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"};var m={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64};var b=7;var y=6;var E=5;var k=4;var A=3;var S=2;var C=1;var T=0;var I;!function(){I={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119}}();var P={w:[{square:I.a1,flag:m.QSIDE_CASTLE},{square:I.h1,flag:m.KSIDE_CASTLE}],b:[{square:I.a8,flag:m.QSIDE_CASTLE},{square:I.h8,flag:m.KSIDE_CASTLE}]};function w(e){return e>>4}function L(e){return e&15}function R(e){var r=L(e),t=w(e);return"abcdefgh".substring(r,r+1)+"87654321".substring(t,t+1)}function O(t){return t===r?e:r}function q(e){return"0123456789".indexOf(e)!==-1}function N(e){var r=e instanceof Array?[]:{};for(var t in e){if(typeof t==="object"){r[t]=N(e[t])}else{r[t]=e[t]}}return r}function D(e){return e.replace(/^\s+|\s+$/g,"")}var K=function(e){var a={board:new Array(128),kings:{w:t,b:t},turn:r,castling:{w:0,b:0},ep_square:t,half_moves:0,move_number:1,history:[],header:{}};this._pos=function(){return a};if(typeof e==="undefined"){this.load(u)}else{this.load(e)}};K.WHITE=r;K.BLACK=e;K.PAWN=a;K.KNIGHT=i;K.BISHOP=o;K.ROOK=n;K.QUEEN=s;K.KING=f;K.SQUARES=function(){var e=[];for(var r=I.a8;r<=I.h1;r++){if(r&136){r+=7;continue}e.push(R(r))}return e}();K.FLAGS=g;K.prototype.load=function(a){var i=this._pos();var o=a.split(/\s+/);var n=o[0];var s=0;var f=l+"12345678/";if(!this.validate_fen(a).valid){return false}this.clear();for(var u=0;u<n.length;u++){var v=n.charAt(u);if(v==="/"){s+=8}else if(q(v)){s+=parseInt(v,10)}else{var p=v<"a"?r:e;this.put({type:v.toLowerCase(),color:p},R(s));s++}}i.turn=o[1];if(o[2].indexOf("K")>-1){i.castling.w|=m.KSIDE_CASTLE}if(o[2].indexOf("Q")>-1){i.castling.w|=m.QSIDE_CASTLE}if(o[2].indexOf("k")>-1){i.castling.b|=m.KSIDE_CASTLE}if(o[2].indexOf("q")>-1){i.castling.b|=m.QSIDE_CASTLE}i.ep_square=o[3]==="-"?t:I[o[3]];i.half_moves=parseInt(o[4],10);i.move_number=parseInt(o[5],10);this._update_setup(this._generate_fen());return true};K.prototype.reset=function(){this.load(u)};K.prototype.moves=function(e){var r=this._generate_moves(e);var t=[];for(var a=0,i=r.length;a<i;a++){if(typeof e!=="undefined"&&"verbose"in e&&e.verbose){t.push(this._make_pretty(r[a]))}else{t.push(this._move_to_san(r[a]))}}return t};K.prototype.in_check=function(){return this._king_attacked(this._pos().turn)};K.prototype.in_checkmate=function(){return this.in_check()&&this._generate_moves().length===0};K.prototype.in_stalemate=function(){return!this.in_check()&&this._generate_moves().length===0};K.prototype.in_draw=function(){return this._pos().half_moves>=100||this.in_stalemate()||this.insufficient_material()||this.in_threefold_repetition()};K.prototype.insufficient_material=function(){var e={};var r=[];var t=0;var a=0;var n=this._pos();for(var s=I.a8;s<=I.h1;s++){a=(a+1)%2;if(s&136){s+=7;continue}var f=n.board[s];if(f){e[f.type]=f.type in e?e[f.type]+1:1;if(f.type===o){r.push(a)}t++}}if(t===2){return true}else if(t===3&&(e[o]===1||e[i]===1)){return true}else if(t===e[o]+2){var l=0;var u=r.length;for(var s=0;s<u;s++){l+=r[s]}if(l===0||l===u){return true}}return false};K.prototype.in_threefold_repetition=function(){var e=[];var r={};var t=false;while(true){var a=this._undo_move();if(!a)break;e.push(a)}while(true){var i=this._generate_fen().split(" ").slice(0,4).join(" ");r[i]=i in r?r[i]+1:1;if(r[i]>=3){t=true}if(!e.length){break}this._make_move(e.pop())}return t};K.prototype.game_over=function(){return this._pos().half_moves>=100||this.in_checkmate()||this.in_stalemate()||this.insufficient_material()||this.in_threefold_repetition()};K.prototype.validate_fen=function(e){var r={0:"No errors.",1:"FEN string must contain six space-delimited fields.",2:"6th field (move number) must be a positive integer.",3:"5th field (half move counter) must be a non-negative integer.",4:"4th field (en-passant square) is invalid.",5:"3rd field (castling availability) is invalid.",6:"2nd field (side to move) is invalid.",7:"1st field (piece positions) does not contain 8 '/'-delimited rows.",8:"1st field (piece positions) is invalid [consecutive numbers].",9:"1st field (piece positions) is invalid [invalid piece].",10:"1st field (piece positions) is invalid [row too large]."};var t=e.split(/\s+/);if(t.length!==6){return{valid:false,error_number:1,error:r[1]}}if(isNaN(t[5])||parseInt(t[5],10)<=0){return{valid:false,error_number:2,error:r[2]}}if(isNaN(t[4])||parseInt(t[4],10)<0){return{valid:false,error_number:3,error:r[3]}}if(!/^(-|[abcdefgh][36])$/.test(t[3])){return{valid:false,error_number:4,error:r[4]}}if(!/^(KQ?k?q?|Qk?q?|kq?|q|-)$/.test(t[2])){return{valid:false,error_number:5,error:r[5]}}if(!/^(w|b)$/.test(t[1])){return{valid:false,error_number:6,error:r[6]}}var a=t[0].split("/");if(a.length!==8){return{valid:false,error_number:7,error:r[7]}}for(var i=0;i<a.length;i++){var o=0;var n=false;for(var s=0;s<a[i].length;s++){if(!isNaN(a[i][s])){if(n){return{valid:false,error_number:8,error:r[8]}}o+=parseInt(a[i][s],10);n=true}else{if(!/^[prnbqkPRNBQK]$/.test(a[i][s])){return{valid:false,error_number:9,error:r[9]}}o+=1;n=false}}if(o!==8){return{valid:false,error_number:10,error:r[10]}}}return{valid:true,error_number:0,error:r[0]}};K.prototype.fen=function(){return this._generate_fen(arguments)};K.prototype.pgn=function(e){var r=typeof e==="object"&&typeof e.newline_char==="string"?e.newline_char:"\n";var t=typeof e==="object"&&typeof e.max_width==="number"?e.max_width:0;var a=[];var i=false;var o=this._pos();for(var n in o.header){a.push("["+n+' "'+o.header[n]+'"]'+r);i=true}if(i&&o.history.length){a.push(r)}var s=[];while(o.history.length>0){s.push(this._undo_move())}var f=[];var l="";var u=1;while(s.length>0){var v=s.pop();if(u===1&&v.color==="b"){l="1. ...";u++}else if(v.color==="w"){if(l.length){f.push(l)}l=u+".";u++}l=l+" "+this._move_to_san(v);this._make_move(v)}if(l.length){f.push(l)}if(typeof o.header.Result!=="undefined"){f.push(o.header.Result)}if(t===0){return a.join("")+f.join(" ")}var p=0;for(var n=0;n<f.length;n++){if(p+f[n].length>t&&n!==0){if(a[a.length-1]===" "){a.pop()}a.push(r);p=0}else if(n!==0){a.push(" ");p++}a.push(f[n]);p+=f[n].length}return a.join("")};K.prototype.load_pgn=function(e,r){function t(e){return e.replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function a(e){var r=false;for(var t in e){r=true}return r}function i(e,r){var t=typeof r==="object"&&typeof r.newline_char==="string"?r.newline_char:"\r?\n";var a={};var i=e.split(t);var o="";var n="";for(var s=0;s<i.length;s++){o=i[s].replace(/^\[([A-Z][A-Za-z]*)\s.*\]$/,"$1");n=i[s].replace(/^\[[A-Za-z]+\s"(.*)"\]$/,"$1");if(D(o).length>0){a[o]=n}}return a}var o=this._pos();var n=typeof r==="object"&&typeof r.newline_char==="string"?r.newline_char:"\r?\n";var s=new RegExp("^(\\[(.|"+t(n)+")*\\])"+"("+t(n)+")*"+"1.("+t(n)+"|.)*$","g");var f=e.replace(s,"$1");if(f[0]!=="["){f=""}this.reset();var l=i(f,r);for(var u in l){this._set_header([u,l[u]])}var p=e.replace(f,"").replace(new RegExp(t(n),"g")," ");p=p.replace(/(\{[^}]+\})+?/g,"");p=p.replace(/\d+\./g,"");var _=D(p).split(new RegExp(/\s+/));_=_.join(",").replace(/,,+/g,",").split(",");var h="";for(var d=0;d<_.length-1;d++){h=this._move_from_san(D(_[d]));if(h==null){return false}else{this._make_move(h)}}h=_[_.length-1];if(v.indexOf(h)>-1){if(a(o.header)&&typeof o.header.Result==="undefined"){this._set_header(["Result",h])}}else{h=this._move_from_san(D(h));if(h==null){return false}else{this._make_move(h)}}return true};K.prototype.header=function(e){this._set_header(e)};K.prototype.ascii=function(){var e="   +------------------------+\n";var t=this.getBoard();for(var a=I.a8;a<=I.h1;a++){if(L(a)===0){e+=" "+"87654321"[w(a)]+" |"}if(t[a]==null){e+=" . "}else{var i=t[a].type;var o=t[a].color;var n=o===r?i.toUpperCase():i.toLowerCase();e+=" "+n+" "}if(a+1&136){e+="|\n";a+=8}}e+="   +------------------------+\n";e+="     a  b  c  d  e  f  g  h\n";return e};K.prototype.turn=function(){return this._pos().turn};K.prototype.move=function(e){var r=null;var t=this._generate_moves();if(typeof e==="string"){for(var a=0,i=t.length;a<i;a++){if(e===this._move_to_san(t[a])){r=t[a];break}}}else if(typeof e==="object"){for(var a=0,i=t.length;a<i;a++){if(e.from===R(t[a].from)&&e.to===R(t[a].to)&&(!("promotion"in t[a])||e.promotion===t[a].promotion)){r=t[a];break}}}if(!r){return null}var o=this._make_pretty(r);this._make_move(r);return o};K.prototype.undo=function(){var e=this._undo_move();return e?this._make_pretty(e):null};K.prototype.clear=function(){var e=this._pos();e.board=new Array(128);e.kings={w:t,b:t};e.turn=r;e.castling={w:0,b:0};e.ep_square=t;e.half_moves=0;e.move_number=1;e.history=[];e.header={};this._update_setup(this._generate_fen())};K.prototype.put=function(e,r){if(!("type"in e&&"color"in e)){return false}if(!e.type||l.indexOf(e.type.toLowerCase())===-1){return false}if(!(r in I)){return false}var t=I[r];this._pos().board[t]={type:e.type,color:e.color};if(e.type===f){this._pos().kings[e.color]=t}this._update_setup(this._generate_fen());return true};K.prototype.get=function(e){var r=this._pos().board[I[e]];return r?{type:r.type,color:r.color}:null};K.prototype.remove=function(e){var r=this.get(e);this._pos().board[I[e]]=null;if(r&&r.type===f){this._pos().kings[r.color]=t}this._update_setup(this._generate_fen());return r};K.prototype.square_color=function(e){if(e in I){var r=I[e];return(w(r)+L(r))%2===0?"light":"dark"}return null};K.prototype.history=function(e){var r=this._pos();var t=[];var a=[];var i=typeof e!=="undefined"&&"verbose"in e&&e.verbose;while(r.history.length>0){t.push(this._undo_move())}while(t.length>0){var o=t.pop();if(i){a.push(this._make_pretty(o))}else{a.push(this._move_to_san(o))}this._make_move(o)}return a};K.prototype._generate_fen=function(){var a=0;var i="";var o=this._pos();for(var n=I.a8;n<=I.h1;n++){if(o.board[n]==null){a++}else{if(a>0){i+=a;a=0}var s=o.board[n].color;var f=o.board[n].type;i+=s===r?f.toUpperCase():f.toLowerCase()}if(n+1&136){if(a>0){i+=a}if(n!==I.h1){i+="/"}a=0;n+=8}}var l="";if(o.castling[r]&m.KSIDE_CASTLE){l+="K"}if(o.castling[r]&m.QSIDE_CASTLE){l+="Q"}if(o.castling[e]&m.KSIDE_CASTLE){l+="k"}if(o.castling[e]&m.QSIDE_CASTLE){l+="q"}l=l||"-";var u=o.ep_square===t?"-":R(o.ep_square);return[i,o.turn,l,u,o.half_moves,o.move_number].join(" ")};K.prototype._set_header=function(e){for(var r=0;r<e.length;r+=2){if(typeof e[r]==="string"&&typeof e[r+1]==="string"){this._pos().header[e[r]]=e[r+1]}}return this._pos().header};K.prototype._update_setup=function(e){var r=this._pos();if(r.history.length>0)return;if(e!==u){r.header["SetUp"]=e;r.header["FEN"]="1"}else{delete r.header["SetUp"];delete r.header["FEN"]}};K.prototype._build_move=function(e,r,t,i,o){var n={color:this._pos().turn,from:r,to:t,flags:i,piece:e[r].type};if(o){n.flags|=m.PROMOTION;n.promotion=o}if(e[t]){n.captured=e[t].type}else if(i&m.EP_CAPTURE){n.captured=a}return n};K.prototype._generate_moves=function(e){this.add_move=function(e,r,t,f,l){if(e[t].type===a&&(w(f)===T||w(f)===b)){var u=[s,n,o,i];for(var v=0,p=u.length;v<p;v++){r.push(this._build_move(e,t,f,l,u[v]))}}else{r.push(this._build_move(e,t,f,l))}};var r=this._pos();var t=[];var f=r.turn;var l=O(f);var u={b:C,w:y};var v=I.a8;var h=I.h1;var d=false;var c=typeof e!=="undefined"&&"legal"in e?e.legal:true;if(typeof e!=="undefined"&&"square"in e){if(e.square in I){v=h=I[e.square];d=true}else{return[]}}for(var g=v;g<=h;g++){if(g&136){g+=7;continue}var E=r.board[g];if(E==null||E.color!==f){continue}if(E.type===a){var k=g+p[f][0];if(r.board[k]==null){this.add_move(r.board,t,g,k,m.NORMAL);var k=g+p[f][1];if(u[f]===w(g)&&r.board[k]==null){this.add_move(r.board,t,g,k,m.BIG_PAWN)}}for(A=2;A<4;A++){var k=g+p[f][A];if(k&136)continue;if(r.board[k]!=null&&r.board[k].color===l){this.add_move(r.board,t,g,k,m.CAPTURE)}else if(k===r.ep_square){this.add_move(r.board,t,g,r.ep_square,m.EP_CAPTURE)}}}else{for(var A=0,S=_[E.type].length;A<S;A++){var P=_[E.type][A];var k=g;while(true){k+=P;if(k&136)break;if(r.board[k]==null){this.add_move(r.board,t,g,k,m.NORMAL)}else{if(r.board[k].color===f)break;this.add_move(r.board,t,g,k,m.CAPTURE);break}if(E.type==="n"||E.type==="k")break}}}}if(!d||h===r.kings[f]){if(r.castling[f]&m.KSIDE_CASTLE){var L=r.kings[f];var R=L+2;if(r.board[L+1]==null&&r.board[R]==null&&!this._attacked(l,r.kings[f])&&!this._attacked(l,L+1)&&!this._attacked(l,R)){this.add_move(r.board,t,r.kings[f],R,m.KSIDE_CASTLE)}}if(r.castling[f]&m.QSIDE_CASTLE){var L=r.kings[f];var R=L-2;if(r.board[L-1]==null&&r.board[L-2]==null&&r.board[L-3]==null&&!this._attacked(l,r.kings[f])&&!this._attacked(l,L-1)&&!this._attacked(l,R)){this.add_move(r.board,t,r.kings[f],R,m.QSIDE_CASTLE)}}}if(!c){return t}var q=[];for(var g=0,S=t.length;g<S;g++){this._make_move(t[g]);if(!this._king_attacked(f)){q.push(t[g])}this._undo_move()}return q};K.prototype._move_to_san=function(e){var r="";if(e.flags&m.KSIDE_CASTLE){r="O-O"}else if(e.flags&m.QSIDE_CASTLE){r="O-O-O"}else{var t=this._get_disambiguator(e);if(e.piece!==a){r+=e.piece.toUpperCase()+t}if(e.flags&(m.CAPTURE|m.EP_CAPTURE)){if(e.piece===a){r+=R(e.from)[0]}r+="x"}r+=R(e.to);if(e.flags&m.PROMOTION){r+="="+e.promotion.toUpperCase()}}this._make_move(e);if(this.in_check()){if(this.in_checkmate()){r+="#"}else{r+="+"}}this._undo_move();return r};K.prototype._move_from_san=function(e){var r,t,i=m.NORMAL,o;var n=e.match(/^([NBKRQ])?([abcdefgh12345678][12345678]?)?(x)?([abcdefgh][12345678])(=[NBRQ])?/);var s=this._pos();if(e.slice(0,5)==="O-O-O"){t=s.kings[s.turn];r=t-2;i=m.QSIDE_CASTLE}else if(e.slice(0,3)==="O-O"){t=s.kings[s.turn];r=t+2;i=m.KSIDE_CASTLE}else if(n&&n[1]){var f=n[1].toLowerCase();if(n[3]){i=m.CAPTURE}r=I[n[4]];for(var l=0,u=_[f].length;l<u;l++){var v=_[f][l];var h=r;while(true){h+=v;if(h&136)break;var d=s.board[h];if(d){if(d.color===s.turn&&d.type===f&&(!n[2]||R(h).indexOf(n[2])>=0)){t=h}break}if(f==="n"||f==="k")break}}}else if(n){if(n[3]){r=I[n[4]];for(var l=2;l<4;l++){var h=r-p[s.turn][l];if(h&136)continue;if(s.board[h]!=null&&s.board[h].color===s.turn&&R(h)[0]===n[2]){t=h}}if(s.board[r]){i=m.CAPTURE}else{i=m.EP_CAPTURE}}else{r=I[e.slice(0,2)];var c=r-p[s.turn][0],d=s.board[c];if(d&&d.type===a&&d.color===s.turn){t=c}else{c=r-p[s.turn][1];d=s.board[c];if(d&&d.type===a&&d.color===s.turn){t=c;i=m.BIG_PAWN}}}if(n[5]){o=n[5][1].toLowerCase()}}if(t>=0&&r>=0&&i){return this._build_move(s.board,t,r,i,o)}else if(e.length>0){}};K.prototype._attacked=function(t,i){var o=this._pos().board;for(var n=I.a8;n<=I.h1;n++){if(n&136){n+=7;continue}if(o[n]==null||o[n].color!==t)continue;var s=o[n];var f=n-i;var l=f+119;if(h[l]&1<<c[s.type]){if(s.type===a){if(f>0){if(s.color===r)return true}else{if(s.color===e)return true}continue}if(s.type==="n"||s.type==="k")return true;var u=d[l];var v=n+u;var p=false;while(v!==i){if(o[v]!=null){p=true;break}v+=u}if(!p)return true}}return false};K.prototype._king_attacked=function(e){return this._attacked(O(e),this._pos().kings[e])};K.prototype._push=function(e){var r=this._pos();r.history.push({move:e,kings:{b:r.kings.b,w:r.kings.w},turn:r.turn,castling:{b:r.castling.b,w:r.castling.w},ep_square:r.ep_square,half_moves:r.half_moves,move_number:r.move_number})};K.prototype._make_move=function(r){var i=this._pos();var o=i.turn;var n=O(o);this._push(r);i.board[r.to]=i.board[r.from];i.board[r.from]=null;if(r.flags&m.EP_CAPTURE){if(i.turn===e){i.board[r.to-16]=null}else{i.board[r.to+16]=null}}if(r.flags&m.PROMOTION){i.board[r.to]={type:r.promotion,color:o}}if(i.board[r.to].type===f){i.kings[i.board[r.to].color]=r.to;if(r.flags&m.KSIDE_CASTLE){var s=r.to-1;var l=r.to+1;i.board[s]=i.board[l];i.board[l]=null}else if(r.flags&m.QSIDE_CASTLE){var s=r.to+1;var l=r.to-2;i.board[s]=i.board[l];i.board[l]=null}i.castling[o]=""}if(i.castling[o]){for(var u=0,v=P[o].length;u<v;u++){if(r.from===P[o][u].square&&i.castling[o]&P[o][u].flag){i.castling[o]^=P[o][u].flag;break}}}if(i.castling[n]){for(var u=0,v=P[n].length;u<v;u++){if(r.to===P[n][u].square&&i.castling[n]&P[n][u].flag){i.castling[n]^=P[n][u].flag;break}}}if(r.flags&m.BIG_PAWN){if(i.turn==="b"){i.ep_square=r.to-16}else{i.ep_square=r.to+16}}else{i.ep_square=t}if(r.piece===a){i.half_moves=0}else if(r.flags&(m.CAPTURE|m.EP_CAPTURE)){i.half_moves=0}else{i.half_moves++}if(i.turn===e){i.move_number++}i.turn=O(i.turn)};K.prototype._undo_move=function(){var r=this._pos();var t=r.history.pop();if(t==null){return null}var i=t.move;r.kings=t.kings;r.turn=t.turn;r.castling=t.castling;r.ep_square=t.ep_square;r.half_moves=t.half_moves;r.move_number=t.move_number;var o=r.turn;var n=O(r.turn);r.board[i.from]=r.board[i.to];r.board[i.from].type=i.piece;r.board[i.to]=null;if(i.flags&m.CAPTURE){r.board[i.to]={type:i.captured,color:n}}else if(i.flags&m.EP_CAPTURE){var s;if(o===e){s=i.to-16}else{s=i.to+16}r.board[s]={type:a,color:n}}if(i.flags&(m.KSIDE_CASTLE|m.QSIDE_CASTLE)){var f,l;if(i.flags&m.KSIDE_CASTLE){f=i.to+1;l=i.to-1}else if(i.flags&m.QSIDE_CASTLE){f=i.to-2;l=i.to+1}r.board[f]=r.board[l];r.board[l]=null}return i};K.prototype._get_disambiguator=function(e){var r=this._generate_moves();var t=e.from;var a=e.to;var i=e.piece;var o=0;var n=0;var s=0;for(var f=0,l=r.length;f<l;f++){var u=r[f].from;var v=r[f].to;var p=r[f].piece;if(i===p&&t!==u&&a===v){o++;if(w(t)===w(u)){n++}if(L(t)===L(u)){s++}}}if(o>0){if(n>0&&s>0){return R(t)}else if(s>0){return R(t).charAt(1)}else{return R(t).charAt(0)}}return""};K.prototype._make_pretty=function(e){var r=N(e);r.san=this._move_to_san(r);r.to=R(r.to);r.from=R(r.from);var t="";for(var a in m){if(m[a]&r.flags){t+=g[a]}}r.flags=t;return r};K.prototype._perft=function(e){var r=this._generate_moves({legal:false});var t=0;var a=this._pos().turn;for(var i=0,o=r.length;i<o;i++){this._make_move(r[i]);if(!this._king_attacked(a)){if(e-1>0){var n=this._perft(e-1);t+=n}else{t++}}this._undo_move()}return t};if(typeof exports!=="undefined")exports.Chess=K}();